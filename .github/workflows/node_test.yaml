name: Node Test

on:
  workflow_call:
    inputs:
      node-version:
        description: "The NodeJS version to use"
        default: "16.17.0"
        required: false
        type: string
      should-update-codecov:
        description: "Boolean indicating whether Codecov should be updated"
        default: true
        required: false
        type: boolean
    secrets:
      CODECOV_TOKEN:
        description: "Codecov token for private repo code coverage reports"
        required: false

defaults:
  run:
    shell: bash

jobs:
  test:
    runs-on: ubuntu-latest
    outputs:
      did-tests-succeed: ${{ steps.run-tests.outputs.did-tests-succeed }} # output provides an explicit named indicator
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: ${{ inputs.node-version }}

      - run: npm install
      - name: Run Tests
        id: run-tests
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        run: |
          if npm run test:ci ; then
            echo "DID TESTS SUCCEED? YES"
            echo "did-tests-succeed=true" >> $GITHUB_OUTPUT
          else
            echo "DID TESTS SUCCEED? NO"
            echo "did-tests-succeed=false" >> $GITHUB_OUTPUT
          fi

          # Ascertain whether Codecov should/can be updated.
          # SHOULD_UPDATE_CODECOV is true by default, with 2 false conditions:
          #   1. If the repo is private and secret.CODECOV_TOKEN was not provided.
          #   2. If input.should-update-codecov was explicitly set to false.

          SHOULD_UPDATE_CODECOV=true

          if [[ ${{ github.repository.private }} == true ]] && [[ -z $CODECOV_TOKEN ]]; then
            SHOULD_UPDATE_CODECOV=false
          fi

          if [[ ${{ inputs.should-update-codecov }} == false ]]; then
            SHOULD_UPDATE_CODECOV=false
          fi

          echo "SHOULD UPDATE CODECOV? $SHOULD_UPDATE_CODECOV"

          echo "should-update-codecov=$SHOULD_UPDATE_CODECOV" >> $GITHUB_OUTPUT

      - name: Update GitHub Commit Status
        run: |
          if [ ${{ steps.run-tests.outputs.did-tests-succeed }} == true ]; then
            echo "(next step) TESTS IN PREVIOUS STEP WERE SUCCESSFUL."
            commit_status_state='success'
            description='Tests passed'
          else
            echo "(next step) TESTS IN PREVIOUS STEP DID NOT SUCCEED."
            commit_status_state='failure'
            description='Tests failed'
          fi

          curl --request POST \
            --url https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.sha }} \
            --header 'authorization: Bearer ${{ secrets.GITHUB_TOKEN }}' \
            --header 'content-type: application/json' \
            --data "{
              \"context\": \"tests\",
              \"state\": \"$commit_status_state\",
              \"description\": \"$description\",
              \"target_url\": \"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
            }"

      - name: Update Codecov
        if: ${{ steps.run-tests.outputs.should-update-codecov == true }}
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }} # Note: "token" is not required for public repos
          directory: ./coverage
          verbose: true
